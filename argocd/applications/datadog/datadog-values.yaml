---
datadog:
  # Cluster configuration
  clusterName: home-lab
  site: datadoghq.eu

  # API key from existing secret
  apiKeyExistingSecret: datadog-api-key

  # Cluster checks and monitoring
  clusterChecks:
    enabled: true
  leaderElection: true
  collectEvents: true

  # Custom integrations for k3s cluster
  confd:
    systemd.yaml: |-
      init_config:

      instances:
        - unit_names:
            - k3s.service
            - k3s-node.service
            - sshd.service
          private_socket: /host/run/systemd/private
    journald.yaml: |-
      init_config:
      logs:
        - type: journald
          path: /host/run/log/journal
          include_units:
            - k3s.service
            - k3s-node.service
            - sshd.service
    etcd.yaml: |-
      init_config:

      instances:
        - prometheus_url: "http://%%env_DD_KUBERNETES_KUBELET_HOST%%:2381/metrics"

    fluxcd.yaml: |-
      init_config:
      instances:
        - metric_patterns:
            include:
              - "*"

  # Container runtime configuration
  criSocketPath: /run/k3s/containerd/containerd.sock

  # Logging configuration
  logs:
    enabled: true
    containerCollectAll: true

  # Process monitoring
  processAgent:
    enabled: true
    processCollection: true
    processDiscovery: true

  # System probe for network and security monitoring
  systemProbe:
    bpfDebug: true
    enableTCPQueueLength: true
    enableOOMKill: true
    enableRuntimeCompiler: true
    enableKernelHeaderDownload: true

  # Monitoring capabilities
  helmCheck:
    enabled: true
    collectEvents: true
  networkMonitoring:
    enabled: true
  serviceMonitoring:
    enabled: true

  # Security monitoring
  securityAgent:
    enabled: true
    runtime:
      enabled: true
      fimEnabled: true
    network:
      enabled: true

  # Prometheus integration
  prometheusScrape:
    enabled: true
    serviceEndpoints: true

  # APM tracing
  apm:
    enabled: true

  # Kubernetes State Metrics
  kubeStateMetricsCore:
    collectVpaMetrics: true

# RBAC configuration
rbac:
  create: true

# Pod labels as tags
podLabelsAsTags:
  app: kube_app
  release: helm_release

# Agent configuration
agents:
  # Use default official Datadog images

  # Container resource configuration (memory request = limit, CPU request only)
  containers:
    agent:
      resources:
        limits:
          memory: 1Gi # Increased from 300Mi to handle k3s cluster monitoring
        requests:
          cpu: 200m
          memory: 1Gi # Same as limit for guaranteed QoS
    processAgent:
      resources:
        limits:
          memory: 500Mi # Increased from 100Mi - was getting OOMKilled constantly
        requests:
          cpu: 100m # Increased for better performance
          memory: 500Mi # Same as limit for guaranteed QoS
    traceAgent:
      resources:
        limits:
          memory: 256Mi # Increased from 150Mi for better performance
        requests:
          cpu: 50m
          memory: 256Mi # Same as limit for guaranteed QoS
    systemProbe:
      resources:
        limits:
          memory: 1Gi # Increased from 512Mi for eBPF compilation and network monitoring
        requests:
          cpu: 100m # Increased for eBPF compilation
          memory: 1Gi # Same as limit for guaranteed QoS
    securityAgent:
      resources:
        limits:
          memory: 256Mi # Increased from 150Mi for runtime security monitoring
        requests:
          cpu: 50m
          memory: 256Mi # Same as limit for guaranteed QoS
    initContainers:
      resources:
        limits:
          memory: 150Mi
        requests:
          cpu: 50m
          memory: 150Mi

  # Node tolerations for scheduling
  tolerations:
    - effect: NoSchedule
      key: ram
      operator: Exists

  # Custom volumes for k3s monitoring
  volumes:
    - hostPath:
        path: /run/log
      name: logdir
    - hostPath:
        path: /run/systemd
      name: systemddir

  volumeMounts:
    - name: logdir
      mountPath: /host/run/log
    - name: systemddir
      mountPath: /host/run/systemd

# Cluster Agent configuration
clusterAgent:
  enabled: true
  tokenExistingSecret: datadog-cluster-agent
  resources:
    limits:
      memory: 256Mi # Increased from 150Mi for better cluster monitoring
    requests:
      cpu: 50m
      memory: 256Mi # Same as limit for guaranteed QoS
  tolerations:
    - effect: NoSchedule
      key: ram
      operator: Exists

# Kube State Metrics configuration
kube-state-metrics:
  resources:
    limits:
      memory: 100Mi
    requests:
      cpu: 50m
      memory: 100Mi
