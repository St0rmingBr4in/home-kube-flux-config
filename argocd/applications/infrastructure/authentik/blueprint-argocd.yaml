---
# Authentik Blueprint for ArgoCD Application
#
# This blueprint automatically creates:
# - ArgoCD Proxy Provider (forward auth)
# - ArgoCD Application
#
# MANUAL STEP REQUIRED:
# The outpost assignment below does NOT work due to a limitation in Authentik blueprints.
# You must manually assign the "ArgoCD Provider" to the "authentik Embedded Outpost" via the UI.
# See README.md for details.
# Tracking: https://github.com/goauthentik/authentik/issues/6779
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprint-argocd
  namespace: prod-infra
  labels:
    app.kubernetes.io/name: authentik
    app.kubernetes.io/instance: authentik
data:
  argocd-app.yaml: |
    version: 1
    metadata:
      name: argocd-application
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      - model: authentik_providers_proxy.proxyprovider
        id: argocd-provider
        attrs:
          name: ArgoCD Provider
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          mode: forward_single
          external_host: https://argocd.st0rmingbr4in.com
      - model: authentik_core.application
        id: argocd-app
        attrs:
          name: ArgoCD
          slug: argocd
          provider: !KeyOf argocd-provider
          meta_launch_url: https://argocd.st0rmingbr4in.com
          meta_icon: https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/png/argocd.png
          meta_description: GitOps Continuous Delivery
          policy_engine_mode: any
          open_in_new_tab: true
      # NOTE: This outpost assignment does NOT work via blueprints
      # Manual assignment required - see README.md
      # Kept here for documentation/future support
      # - model: authentik_outposts.outpost
      #   identifiers:
      #     name: authentik Embedded Outpost
      #   state: present
      #   attrs:
      #     providers:
      #       - !Find [authentik_providers_proxy.proxyprovider, [name, "ArgoCD Provider"]]
