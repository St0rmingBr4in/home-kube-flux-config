---
operator:
  verify:
    enabled: false
  traefik:
    namespace: prod-infra

ingress:
  main:
    enabled: false

service:
  main:
    ports:
      main:
        port: 10095
        targetPort: 8080
  torrent:
    enabled: true
    type: LoadBalancer
    loadBalancerClass: tailscale
    annotations:
      tailscale.com/hostname: "qbittorrent-torrent"
    ports:
      torrent:
        enabled: true
        port: 6881
        targetPort: 6881
        protocol: tcp

resources:
  limits:
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 1Gi

persistence:
  config:
    enabled: true
    existingClaim: qbittorrent-config
  downloads:
    enabled: true
    existingClaim: media-downloads
    mountPath: /downloads

env:
  TZ: Europe/Paris

securityContext:
  runAsUser: 1031
  runAsGroup: 100

# Secret stub (disabled) â€” actual secret created by VaultStaticSecret as qbittorrent-tailscale-authkey
secret:
  tailscale-authkey:
    enabled: false
    type: Opaque
    data:
      TS_AUTHKEY: "placeholder"

# Tailscale sidecar to route qBittorrent traffic through inlet exit node
tailscaleImage:
  repository: ghcr.io/tailscale/tailscale
  tag: latest
  pullPolicy: Always

# Allow Tailscale containerboot to init its K8s client (needed even with TS_KUBE_SECRET="")
podOptions:
  automountServiceAccountToken: true
  dnsPolicy: "None"
  dnsConfig:
    nameservers:
      - "8.8.8.8"
      - "1.1.1.1"
    searches:
      - "prod-media.svc.cluster.local"
      - "svc.cluster.local"
      - "cluster.local"

workload:
  main:
    podSpec:
      containers:
        tailscale:
          enabled: true
          primary: false
          imageSelector: tailscaleImage
          env:
            TS_AUTHKEY:
              secretKeyRef:
                name: tailscale-authkey
                key: TS_AUTHKEY
            TS_HOSTNAME: qbittorrent
            TS_EXTRA_ARGS: "--exit-node=100.123.88.118 --exit-node-allow-lan-access"
            TS_STATE_DIR: /tmp/tailscale
            TS_ACCEPT_DNS: "false"
            TS_KUBE_SECRET: ""
            TS_USERSPACE: "false"
          probes:
            liveness:
              enabled: false
            readiness:
              enabled: false
            startup:
              enabled: false
          securityContext:
            runAsUser: 0
            runAsNonRoot: false
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW
            privileged: true
          resources:
            limits:
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
